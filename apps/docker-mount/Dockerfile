## This file is automatically generated (based on release.json)
##
## Do not changes any lines here
##
####################################
# All rights reserved.              #
# started from Zero                 #
# Docker owned dockserver           #
# Docker Maintainer dockserver      #
#####################################
#####################################
# THIS DOCKER IS UNDER LICENSE      #
# NO CUSTOMIZING IS ALLOWED         #
# NO REBRANDING IS ALLOWED          #
# NO CODE MIRRORING IS ALLOWED      #
#####################################
# shellcheck disable=SC2086
# shellcheck disable=SC2046
FROM alpine:3.16.1 as builder

LABEL org.opencontainers.image.source="https://github.com/dockserver/container"

### BUILD STAGE
ARG TARGETPLATFORM
ARG BUILDPLATFORM

ARG MERGERFS_VERSION=2.33.5

RUN \
  echo "**** update packages ****" && \
    apk --quiet --no-cache --no-progress update && \
  apk --quiet --no-cache --no-progress upgrade && \
  echo "**** install build packages ****" && \
    apk add -U --update --no-cache --quiet bash wget unzip git fuse libattr libstdc++ autoconf \
      automake libtool gettext-dev attr-dev linux-headers make \
      build-base libattr libstdc++ tar curl && \
  echo "**** install mergerfs ****" && \
    mkdir -p /tmp/mergerfs && \
    curl -fsSL "https://github.com/trapexit/mergerfs/releases/download/${MERGERFS_VERSION}/mergerfs-${MERGERFS_VERSION}.tar.gz" | tar xzf - -C /tmp/mergerfs --strip-components=1 && \
    cd /tmp/mergerfs && make STATIC=1 LTO=1 && make install && \
  echo "**** install rclone ****" && \
    wget -qO- https://rclone.org/install.sh | bash && \
  echo "**** install language pack ****" && \
    mkdir -p /app && \
    cd /app && git clone --quiet https://github.com/dockserver/language.git && \
  echo "*** cleanup build dependencies ****" && \
    apk del --purge --quiet \
    bash wget unzip git fuse libattr libstdc++ autoconf \
      automake libtool gettext-dev attr-dev linux-headers make \
      build-base libattr libstdc++ tar curl && \
  echo "*** cleanup build system ****" && \
    apk del --quiet --clean-protected --no-progress && \
    rm -rf /var/cache/apk/* /tmp/*

FROM ghcr.io/dockserver/docker-alpine-v3:v3.16.1

ARG TARGETPLATFORM
ARG BUILDPLATFORM

ARG BASE_VERSION=3.16.1
ARG ALPINE_VERSION=3.16.1
ARG MERGERFS_VERSION=2.33.5
ARG RCLONE_VERSION=v1.59.1
ARG LANG_VERSION=v0.0.19

RUN \
  echo "**** update packages ****" && \
    apk --quiet --no-cache --no-progress update && \
  apk --quiet --no-cache --no-progress upgrade && \
  echo "**** install build packages ****" && \
    apk add -U --update --no-cache --quiet bash jq musl findutils linux-headers apk-tools busybox coreutils procps shadow && \
  echo "**** set alpine version ****" && \
    echo -e "3.16.1" > /etc/alpine-release && \
  echo "*** cleanup system ****" && \
    apk del --quiet --clean-protected --no-progress && \
    rm -rf /var/cache/apk/* /tmp/*

COPY --chown=abc --chmod=755 ./apps/docker-mount/root/ /

COPY --from=builder --chown=abc --chmod=755 /usr/local/bin/mergerfs /usr/local/bin/mergerfs
COPY --from=builder --chown=abc --chmod=755 /usr/local/bin/mergerfs-fusermount /usr/local/bin/mergerfs-fusermount
COPY --from=builder --chown=abc --chmod=755 /sbin/mount.mergerfs /sbin/mount.mergerfs
COPY --from=builder --chown=abc --chmod=755 /usr/bin/rclone /usr/local/bin/rclone
COPY --from=builder --chown=abc --chmod=755 /app/language /app/language

VOLUME /system

ENTRYPOINT /init
##EOF
